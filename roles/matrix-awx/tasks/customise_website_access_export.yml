

- name: Enable index.html creation if user doesn't wish to customise base domain
  delegate_to: 127.0.0.1
  lineinfile:
    path: '/var/lib/awx/projects/clients/{{ member_id }}/{{ subscription_id }}/matrix_vars.yml'
    regexp: "^#? *{{ item.key | regex_escape() }}:"
    line: "{{ item.key }}: {{ item.value }}"
    insertafter: '# Base Domain Settings'
  with_dict:
    'matrix_nginx_proxy_base_domain_homepage_enabled': 'true'
  when: customise_base_domain_website|bool == false

- name: Disable index.html creation to allow multi-file site if user does wish to customise base domain
  delegate_to: 127.0.0.1
  lineinfile:
    path: '/var/lib/awx/projects/clients/{{ member_id }}/{{ subscription_id }}/matrix_vars.yml'
    regexp: "^#? *{{ item.key | regex_escape() }}:"
    line: "{{ item.key }}: {{ item.value }}"
    insertafter: '# Base Domain Settings'
  with_dict:
    'matrix_nginx_proxy_base_domain_homepage_enabled': 'false'
  when: customise_base_domain_website|bool == true

- name: Record 'Customise Website + Access Export' variables locally on AWX
  delegate_to: 127.0.0.1
  lineinfile:
    path: '/var/lib/awx/projects/clients/{{ member_id }}/{{ subscription_id }}/matrix_vars.yml'
    regexp: "^#? *{{ item.key | regex_escape() }}:"
    line: "{{ item.key }}: {{ item.value }}"
    insertafter: '# AWX Settings'
  with_dict:
    'customise_base_domain_website': '{{ customise_base_domain_website }}'

- name: Copy new 'matrix_vars.yml' to target machine
  copy:
    src: '/var/lib/awx/projects/clients/{{ member_id }}/{{ subscription_id }}/matrix_vars.yml'
    dest: '/matrix/awx/matrix_vars.yml'
    mode: '0660'

- name: Reload vars in matrix_vars.yml
  include_vars:
    file: '/var/lib/awx/projects/clients/{{ member_id }}/{{ subscription_id }}/matrix_vars.yml'
  no_log: True

- name: Save new 'Customise Website + Access Export' survey.json to the AWX tower, template
  delegate_to: 127.0.0.1
  template:
    src: './roles/matrix-awx/surveys/configure_website_access_export.json.j2'
    dest: '/var/lib/awx/projects/clients/{{ member_id }}/{{ subscription_id }}/configure_website_access_export.json'

- name: Copy new 'Customise Website + Access Export' survey.json to target machine
  copy:
    src: '/var/lib/awx/projects/clients/{{ member_id }}/{{ subscription_id }}/configure_website_access_export.json'
    dest:  '/matrix/awx/configure_website_access_export.json'
    mode: '0660'

- name: Collect AWX admin token the hard way!
  delegate_to: 127.0.0.1
  shell: |
      curl -sku {{ tower_username }}:{{ tower_password }} -H "Content-Type: application/json" -X POST -d '{"description":"Tower CLI", "application":null, "scope":"write"}' https://{{ tower_host }}/api/v2/users/1/personal_tokens/ | jq '.token' | sed -r 's/\"//g'
  register: tower_token
  no_log: True

- name: Recreate 'Customise Base Domain Export' job template
  delegate_to: 127.0.0.1
  awx.awx.tower_job_template:
    name: "{{ matrix_domain }} - 1 - Configure Website + Access Export"
    description: "Configure base domain website settings and access the servers export."
    extra_vars: "{{ lookup('file', '/var/lib/awx/projects/clients/{{ member_id }}/{{ subscription_id }}/extra_vars.json') }}"
    job_type: run
    job_tags: "start,setup-nginx-proxy"
    inventory: "{{ member_id }}"
    project: "{{ member_id }} - Matrix Docker Ansible Deploy"
    playbook: setup.yml
    credential: "{{ member_id }} - AWX SSH Key"
    survey_enabled: true
    survey_spec: "{{ lookup('file', '/var/lib/awx/projects/clients/{{ member_id }}/{{ subscription_id }}/configure_website_access_export.json') }}"
    become_enabled: yes
    state: present
    verbosity: 1
    tower_host: "https://{{ tower_host }}"
    tower_oauthtoken: "{{ tower_token.stdout }}"
    validate_certs: yes

# Copied over from provision stage

- name: Copy ssh_sftp.service file
  copy:
    src: './roles/matrix-awx/templates/sftp/ssh_sftp.service'
    dest: '/lib/systemd/system/ssh_sftp.service'
    mode: 0644

- name: Copy sshd config file for Password entry
  copy:
    src: './roles/matrix-awx/templates/sftp/sshd_sftp_config_password'
    dest: '/etc/ssh/sshd_sftp_config'
    mode: 0644
  when: sftp_auth_method == "Password"
  
- name: Copy sshd config file for SSH key entry
  copy:
    src: './roles/matrix-awx/templates/sftp/sshd_sftp_config_key'
    dest: '/etc/ssh/sshd_sftp_config'
    mode: 0644
  when: sftp_auth_method == "SSH Key"

- name: Ensure group "sftp" exists
  group:
    name: sftp
    state: present

- name: If user doesn't define a sftp_password, create a disabled 'sftp' account
  user:
    name: sftp
    comment: SFTP user to set custom web files and access servers export
    shell: /bin/false
    home: /chroot/
    group: sftp
    password: '*'
    update_password: always
  when: sftp_password|length == 0

- name: If user defines sftp_password, enable account and set password on 'stfp' account
  user:
    name: sftp
    comment: SFTP user to set custom web files and access servers export
    shell: /bin/false
    home: /chroot/
    group: sftp
    password: "{{ sftp_password | password_hash('sha512') }}"
    update_password: always
  when: sftp_password|length > 0

# would be safer if it generated the password for you!

- name: Setup SFTP users default root path
  shell: sudo usermod -d / sftp

- name: adding existing user 'sftp' to group matrix
  user:
    name: sftp
    groups: matrix
    append: yes

- name: Create the ro /chroot directory with sticky bit if it doesn't exist. (/chroot/website has matrix:matrix permissions and is mounted to nginx container)
  file:
    path: /chroot
    state: directory
    owner: root
    group: root
    mode: '1755'

- name: Ensure /chroot/website location exists.
  file:
    path: /chroot/website
    state: directory
    owner: matrix
    group: matrix
    mode: '0574'

- name: Ensure /chroot/export location exists
  file:
    path: /chroot/export
    state: directory
    owner: sftp
    group: sftp
    mode: '0700'

- name: Ensure /chroot/.ssh location exists
  file:
    path: /chroot/.ssh
    state: directory
    owner: sftp
    group: sftp
    mode: '0700'

- name: Ensure /chroot/authorized_keys exists
  file:
    path: /chroot/.ssh/authorized_keys
    state: touch
    owner: sftp
    group: sftp
    mode: '0644'

- name: Clear authorized_keys file
  command: echo "" > /chroot/.ssh/authorized_keys

- name: Insert public SSH key into authorized_keys file
  lineinfile:
    path: /chroot/.ssh/authorized_keys
    line: "{{ sftp_public_key }}"
    owner: sftp
    group: sftp
    mode: '0644'
  when: sftp_public_key|length > 0

- name: Disable service ssh_sftp.service
  service:
    name: ssh_sftp.service
    enabled: no
  when: sftp_auth_method == "Disabled"

- name: Enable service ssh_sftp.service
  service:
    name: ssh_sftp.service
    enabled: yes
  when: sftp_auth_method != "Disabled"

- name: Stop service ssh_sftp.service
  service:
    name: ssh_sftp.service
    state: stopped
  when: sftp_auth_method == "Disabled"

- name: Start service ssh_sftp.service
  service:
    name: ssh_sftp.service
    state: started
  when: sftp_auth_method != "Disabled"

